<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒãƒƒãƒ—</title>
    <!-- PDFå‡ºåŠ›ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Excelèª­ã¿è¾¼ã¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: #4285f4;
            color: white;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 100;
            flex-wrap: wrap;
        }
        .header h1 {
            font-size: 16px;
            font-weight: 600;
        }
        
        /* ãƒœã‚¿ãƒ³å…±é€š */
        .btn {
            background: white;
            color: #4285f4;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        .btn:hover {
            background: #f0f0f0;
        }
        .btn-pdf {
            background: #34a853;
            color: white;
        }
        .btn-pdf:hover {
            background: #2d8f47;
        }
        
        /* ä»¶æ•°è¡¨ç¤º */
        .count-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: auto;
        }
        
        /* åœ°å›³ */
        #map {
            width: 100%;
            height: calc(100vh - 52px);
        }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’éš ã™ */
        #csvInput {
            display: none;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        .loading.show {
            display: block;
        }
        
        /* ä¼šç¤¾åãƒ©ãƒ™ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .marker-label {
            background: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* å¹ãå‡ºã—å†…ã®ãƒ•ã‚©ãƒ¼ãƒ  */
        .info-form {
            padding: 8px;
            min-width: 260px;
        }
        .info-form h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
            border-bottom: 2px solid #4285f4;
            padding-bottom: 6px;
        }
        .info-row {
            margin: 6px 0;
            font-size: 13px;
        }
        .info-label {
            font-weight: bold;
            color: #555;
        }
        .info-form input, .info-form select, .info-form textarea {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .info-form textarea {
            resize: vertical;
            min-height: 60px;
        }
        .route-select {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .color-preview {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #333;
        }
        .save-btn {
            width: 100%;
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .save-btn:hover {
            background: #3367d6;
        }
        
        /* ãƒ«ãƒ¼ãƒˆå‡¡ä¾‹ */
        .legend {
            position: fixed;
            bottom: 20px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 100;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 4px 0;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒãƒƒãƒ—</h1>
        <button class="btn" onclick="document.getElementById('csvInput').click()">
            ğŸ“ èª­è¾¼
        </button>
        <button class="btn btn-pdf" onclick="exportPDF()">
            ğŸ“„ PDFå‡ºåŠ›
        </button>
        <div class="count-badge" id="countBadge">0ä»¶</div>
    </div>
    
    <input type="file" id="csvInput" accept=".csv,.xlsx,.xls" onchange="handleFile(event)">
    
    <div id="map"></div>
    
    <!-- ãƒ«ãƒ¼ãƒˆå‡¡ä¾‹ -->
    <div class="legend" id="legend" style="display: none;">
        <div class="legend-title">ğŸ“ ãƒ«ãƒ¼ãƒˆå‡¡ä¾‹</div>
        <div id="legendItems"></div>
    </div>
    
    <div class="loading" id="loading">
        ğŸ“ ä½æ‰€ã‚’å¤‰æ›ä¸­...<br>
        <span id="loadingProgress"></span>
    </div>

    <script>
        let map;
        let markers = [];
        let infoWindow;
        let locationData = []; // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        
        // 10è‰²ã®ãƒ«ãƒ¼ãƒˆè¨­å®š
        const ROUTES = [
            { id: 0, name: 'æœªè¨­å®š', color: '#00BCD4', icon: 'https://maps.google.com/mapfiles/ms/icons/ltblue-dot.png' },
            { id: 1, name: 'ãƒ«ãƒ¼ãƒˆ1', color: '#F44336', icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png' },
            { id: 2, name: 'ãƒ«ãƒ¼ãƒˆ2', color: '#4CAF50', icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png' },
            { id: 3, name: 'ãƒ«ãƒ¼ãƒˆ3', color: '#2196F3', icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png' },
            { id: 4, name: 'ãƒ«ãƒ¼ãƒˆ4', color: '#FFEB3B', icon: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png' },
            { id: 5, name: 'ãƒ«ãƒ¼ãƒˆ5', color: '#9C27B0', icon: 'https://maps.google.com/mapfiles/ms/icons/purple-dot.png' },
            { id: 6, name: 'ãƒ«ãƒ¼ãƒˆ6', color: '#FF9800', icon: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png' },
            { id: 7, name: 'ãƒ«ãƒ¼ãƒˆ7', color: '#E91E63', icon: 'https://maps.google.com/mapfiles/ms/icons/pink-dot.png' },
            { id: 8, name: 'ãƒ«ãƒ¼ãƒˆ8', color: '#9E9E9E', icon: 'https://maps.google.com/mapfiles/ms/icons/grey-dot.png' },
            { id: 9, name: 'ãƒ«ãƒ¼ãƒˆ9', color: '#795548', icon: 'https://mt.googleapis.com/vt/icon/name=icons/spotlight/spotlight-poi.png&scale=1' },
            { id: 10, name: 'ãƒ«ãƒ¼ãƒˆ10', color: '#607D8B', icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png' }
        ];
        
        function initMap() {
            const chiyoda = { lat: 35.6939, lng: 139.7535 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: chiyoda,
            });
            
            infoWindow = new google.maps.InfoWindow();
            
            // LocalStorageã‹ã‚‰å¾©å…ƒ
            loadFromStorage();
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆExcel/CSVä¸¡å¯¾å¿œï¼‰
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                // Excelãƒ•ã‚¡ã‚¤ãƒ«
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’å–å¾—
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // JSONå½¢å¼ã«å¤‰æ›
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    if (jsonData.length > 1) {
                        parseExcelData(jsonData);
                    } else {
                        alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // CSVãƒ•ã‚¡ã‚¤ãƒ«
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    parseCSV(text);
                };
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        // ä½æ‰€ã‚’æ­£è¦åŒ–ï¼ˆéšæ•°ãƒ»éƒ¨å±‹ç•ªå·ã‚’é™¤å»ï¼‰
        function normalizeAddress(address) {
            if (!address) return '';
            
            // éšæ•°ã€éƒ¨å±‹ç•ªå·ãªã©ã‚’é™¤å»ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
            let normalized = address
                .replace(/\s+/g, '') // ã‚¹ãƒšãƒ¼ã‚¹é™¤å»
                .replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)) // å…¨è§’â†’åŠè§’
                .replace(/[\uFF21-\uFF3A\uFF41-\uFF5A]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)) // å…¨è§’è‹±å­—â†’åŠè§’
                .replace(/(\d+)éš.*$/i, '') // ã€Œ15éšã€ä»¥é™ã‚’é™¤å»
                .replace(/(\d+)F.*$/i, '') // ã€Œ15Fã€ä»¥é™ã‚’é™¤å»
                .replace(/(\d+)ï¼¦.*$/i, '') // ã€Œ15ï¼¦ã€ä»¥é™ã‚’é™¤å»
                .replace(/\d+å·å®¤.*$/i, '') // ã€Œ101å·å®¤ã€ä»¥é™ã‚’é™¤å»
                .replace(/[A-Za-z]æ£Ÿ.*$/i, '') // ã€ŒAæ£Ÿã€ä»¥é™ã‚’é™¤å»
                .trim();
            
            return normalized;
        }
        
        // éšæ•°æƒ…å ±ã‚’æŠ½å‡º
        function extractFloorInfo(address) {
            if (!address) return '';
            
            // éšæ•°ã‚’æŠ½å‡º
            const floorMatch = address.match(/(\d+)[éšFï¼¦]/i);
            if (floorMatch) {
                return floorMatch[1] + 'éš';
            }
            
            // éƒ¨å±‹ç•ªå·ã‚’æŠ½å‡º
            const roomMatch = address.match(/(\d+)å·å®¤/);
            if (roomMatch) {
                return roomMatch[1] + 'å·å®¤';
            }
            
            return '';
        }
        
        // åŒä¸€ä½æ‰€ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        function groupByAddress(dataList) {
            const groups = {};
            
            dataList.forEach(item => {
                const normalizedAddr = normalizeAddress(item.address);
                
                if (!groups[normalizedAddr]) {
                    groups[normalizedAddr] = {
                        ...item,
                        originalAddress: item.address,
                        count: 1,
                        floors: [],
                        allItems: [item]
                    };
                    
                    const floor = extractFloorInfo(item.address);
                    if (floor) {
                        groups[normalizedAddr].floors.push(floor);
                    }
                } else {
                    groups[normalizedAddr].count++;
                    groups[normalizedAddr].allItems.push(item);
                    
                    const floor = extractFloorInfo(item.address);
                    if (floor && !groups[normalizedAddr].floors.includes(floor)) {
                        groups[normalizedAddr].floors.push(floor);
                    }
                    
                    // ä¼šç¤¾æƒ…å ±ã‚’çµåˆ
                    if (item.info && !groups[normalizedAddr].info.includes(item.info)) {
                        groups[normalizedAddr].info = groups[normalizedAddr].info 
                            ? groups[normalizedAddr].info + ' / ' + item.info 
                            : item.info;
                    }
                }
            });
            
            // ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒªã‚¹ãƒˆã«å¤‰æ›
            return Object.values(groups).map(group => {
                // éšæ•°æƒ…å ±ã‚’å‚™è€ƒã«è¿½åŠ 
                let floorNote = '';
                if (group.floors.length > 0) {
                    floorNote = 'ã€éšæ•°ã€‘' + group.floors.join(', ');
                }
                
                return {
                    ...group,
                    company: group.company,
                    displayName: group.company + (group.count > 1 ? `ï¼ˆ${group.count}å°ï¼‰` : ''),
                    note: floorNote + (group.info ? '\n' + group.info : ''),
                    info: group.info
                };
            });
        }
        
        // Excelãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆãƒãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰å½¢å¼å¯¾å¿œï¼‰
        function parseExcelData(rows) {
            const data = [];
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’æ¢ã™ï¼ˆã€Œç®¡ç†NOã€ã¾ãŸã¯ã€ŒUç®¡ç†NOã€ã‚’å«ã‚€è¡Œï¼‰
            let headerRowIndex = -1;
            let columnMap = {};
            
            for (let i = 0; i < Math.min(rows.length, 10); i++) {
                const row = rows[i];
                if (!row) continue;
                
                const rowStr = row.map(cell => String(cell || '')).join(',');
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ¤œå‡ºï¼ˆç®¡ç†NOãŒã‚ã‚‹è¡Œã‚’æ¢ã™ï¼‰
                if (rowStr.includes('ç®¡ç†NO') || rowStr.includes('ç®¡ç†No')) {
                    headerRowIndex = i;
                    
                    // åˆ—ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
                    row.forEach((cell, index) => {
                        const cellStr = String(cell || '').trim();
                        
                        if (cellStr.includes('ç®¡ç†NO') || cellStr.includes('ç®¡ç†No') || cellStr === 'NO') {
                            columnMap.no = index;
                        }
                        if (cellStr.includes('è¨­ç½®å…ˆä¼šç¤¾å') || cellStr === 'ä¼šç¤¾å') {
                            columnMap.company = index;
                        }
                        if (cellStr === 'éƒ½é“åºœçœŒ') {
                            columnMap.prefecture = index;
                        }
                        if (cellStr === 'ä½æ‰€') {
                            columnMap.address = index;
                        }
                        if (cellStr.includes('TEL') || cellStr.includes('é›»è©±')) {
                            columnMap.phone = index;
                        }
                        if (cellStr.includes('æ‹…å½“è€…')) {
                            columnMap.contact = index;
                        }
                        if (cellStr.includes('è¨­ç½®å…ˆæƒ…å ±') || cellStr.includes('ä¼šç¤¾æƒ…å ±') || cellStr.includes('å‚™è€ƒ')) {
                            columnMap.info = index;
                        }
                    });
                    
                    // ä¼šç¤¾ååˆ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ‡ãƒ¼ã‚¿è¡Œã‹ã‚‰æ¨æ¸¬
                    // ç®¡ç†NOã®2ã¤å¾Œï¼ˆäº¤æ›ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å¾Œï¼‰ã«ä¼šç¤¾åãŒã‚ã‚‹ã“ã¨ãŒå¤šã„
                    if (columnMap.company === undefined && columnMap.no !== undefined) {
                        columnMap.company = columnMap.no + 2; // ç®¡ç†NOã®2åˆ—å¾Œ
                    }
                    
                    // ä½æ‰€åˆ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€éƒ½é“åºœçœŒã®æ¬¡ã®åˆ—ã‚’ä½¿ã†
                    if (columnMap.address === undefined && columnMap.prefecture !== undefined) {
                        columnMap.address = columnMap.prefecture + 1;
                    }
                    
                    break;
                }
            }
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å¾“æ¥ã®æ–¹å¼ï¼ˆ1è¡Œç›®ãŒãƒ˜ãƒƒãƒ€ãƒ¼ã€å›ºå®šåˆ—ï¼‰
            if (headerRowIndex === -1) {
                headerRowIndex = 0;
                columnMap = { no: 0, company: 1, address: 2, phone: 3, contact: 4, info: 5 };
            }
            
            console.log('ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ:', headerRowIndex);
            console.log('åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°:', columnMap);
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ãƒ‘ãƒ¼ã‚¹
            for (let i = headerRowIndex + 1; i < rows.length; i++) {
                const values = rows[i];
                if (!values) continue;
                
                // ä¼šç¤¾åã‚’å–å¾—
                let company = '';
                if (columnMap.company !== undefined) {
                    company = String(values[columnMap.company] || '');
                }
                
                // ä¼šç¤¾åãŒãªã„å ´åˆã€ãƒ‡ãƒ¼ã‚¿è¡Œã®å¯èƒ½æ€§ãŒã‚ã‚‹åˆ—ã‚’æ¢ã™
                // ï¼ˆç®¡ç†NOã®2åˆ—å¾Œã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
                if ((!company || company === 'undefined' || company === 'NaN' || company === 'null') && columnMap.no !== undefined) {
                    const possibleCompanyCol = columnMap.no + 2;
                    if (values[possibleCompanyCol]) {
                        company = String(values[possibleCompanyCol] || '');
                    }
                }
                
                if (!company || company === 'undefined' || company === 'NaN' || company === 'null' || company === 'NaN') continue;
                
                // ä½æ‰€ã‚’çµ„ã¿ç«‹ã¦ï¼ˆéƒ½é“åºœçœŒ + ä½æ‰€ï¼‰
                let address = '';
                if (columnMap.prefecture !== undefined && values[columnMap.prefecture]) {
                    address += String(values[columnMap.prefecture] || '');
                }
                if (columnMap.address !== undefined && values[columnMap.address]) {
                    address += String(values[columnMap.address] || '');
                }
                
                if (!address) continue; // ä½æ‰€ãŒãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
                
                // é›»è©±ç•ªå·ã‚’å–å¾—
                let phone = '';
                if (columnMap.phone !== undefined) {
                    phone = String(values[columnMap.phone] || '');
                }
                
                // æ‹…å½“è€…ã‚’å–å¾—
                let contact = '';
                if (columnMap.contact !== undefined) {
                    contact = String(values[columnMap.contact] || '');
                }
                
                // è¨­ç½®å…ˆæƒ…å ±ã‚’å–å¾—
                let info = '';
                if (columnMap.info !== undefined) {
                    info = String(values[columnMap.info] || '');
                }
                
                data.push({
                    id: 'loc_' + Date.now() + '_' + i,
                    no: columnMap.no !== undefined ? String(values[columnMap.no] || '') : '',
                    company: company,
                    address: address,
                    phone: phone,
                    contact: contact,
                    info: (info && info !== 'NaN' && info !== 'undefined') ? info : '',
                    // ã‚¢ãƒæƒ…å ±ï¼ˆåˆæœŸå€¤ï¼‰
                    routeId: 0,
                    appointmentDate: '',
                    appointmentTime: '',
                    note: '',
                    position: null
                });
            }
            
            if (data.length > 0) {
                console.log('èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿æ•°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åŒ–å‰ï¼‰:', data.length);
                
                // åŒä¸€ä½æ‰€ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const groupedData = groupByAddress(data);
                console.log('èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿æ•°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åŒ–å¾Œï¼‰:', groupedData.length);
                console.log('æœ€åˆã®ãƒ‡ãƒ¼ã‚¿:', groupedData[0]);
                
                geocodeAddresses(groupedData);
            } else {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // CSVã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ï¼ˆãƒãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰å½¢å¼å¯¾å¿œï¼‰
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const rows = lines.map(line => parseCSVLine(line));
            
            // Excelã¨åŒã˜å‡¦ç†ã‚’ä½¿ã†
            parseExcelData(rows);
        }
        
        // CSVã®1è¡Œã‚’ãƒ‘ãƒ¼ã‚¹
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }
        
        // ä½æ‰€ã‚’ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
        async function geocodeAddresses(data) {
            markers.forEach(m => m.setMap(null));
            markers = [];
            locationData = [];
            
            const loading = document.getElementById('loading');
            const progress = document.getElementById('loadingProgress');
            loading.classList.add('show');
            
            const geocoder = new google.maps.Geocoder();
            const bounds = new google.maps.LatLngBounds();
            let successCount = 0;
            
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                progress.textContent = `${i + 1} / ${data.length}`;
                
                try {
                    const position = await geocodeAddress(geocoder, item.address);
                    if (position) {
                        item.position = { lat: position.lat(), lng: position.lng() };
                        locationData.push(item);
                        createMarker(item);
                        bounds.extend(position);
                        successCount++;
                    }
                } catch (error) {
                    console.warn(`ä½æ‰€å¤‰æ›å¤±æ•—: ${item.address}`, error);
                }
                
                await sleep(200);
            }
            
            loading.classList.remove('show');
            document.getElementById('countBadge').textContent = `${successCount}ä»¶`;
            
            if (successCount > 0) {
                map.fitBounds(bounds);
            }
            
            document.getElementById('csvInput').value = '';
            
            // ä¿å­˜
            saveToStorage();
            updateLegend();
        }
        
        // ä½æ‰€â†’åº§æ¨™å¤‰æ›
        function geocodeAddress(geocoder, address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ address: address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve(results[0].geometry.location);
                    } else {
                        reject(status);
                    }
                });
            });
        }
        
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
        function createMarker(item) {
            const route = ROUTES[item.routeId] || ROUTES[0];
            
            // è¡¨ç¤ºåï¼ˆå°æ•°ä»˜ãï¼‰
            const displayName = item.displayName || item.company;
            
            const marker = new google.maps.Marker({
                position: item.position,
                map: map,
                title: displayName,
                label: {
                    text: displayName,
                    className: 'marker-label',
                    fontSize: '11px',
                    fontWeight: 'bold'
                },
                icon: {
                    url: route.icon,
                    labelOrigin: new google.maps.Point(15, -10)
                }
            });
            
            marker.itemId = item.id;
            
            marker.addListener('click', () => {
                showInfoWindow(item, marker);
            });
            
            markers.push(marker);
        }
        
        // æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
        function showInfoWindow(item, marker) {
            const route = ROUTES[item.routeId] || ROUTES[0];
            
            // è¡¨ç¤ºåï¼ˆå°æ•°ä»˜ãï¼‰
            const displayName = item.displayName || item.company;
            
            // å°æ•°è¡¨ç¤º
            const countDisplay = item.count > 1 ? `<div style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; margin-bottom: 8px; font-size: 13px;">ğŸ“¦ <strong>${item.count}å°</strong> è¨­ç½®</div>` : '';
            
            // éšæ•°æƒ…å ±
            const floorDisplay = (item.floors && item.floors.length > 0) 
                ? `<div class="info-row"><span class="info-label">ğŸ¢ è¨­ç½®éšï¼š</span>${item.floors.join(', ')}</div>` 
                : '';
            
            // ãƒ«ãƒ¼ãƒˆé¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³
            let routeOptions = ROUTES.map(r => 
                `<option value="${r.id}" ${item.routeId === r.id ? 'selected' : ''}>${r.name}</option>`
            ).join('');
            
            const content = `
                <div class="info-form">
                    <h3>${displayName}</h3>
                    
                    ${countDisplay}
                    
                    <div class="info-row">
                        <span class="info-label">ğŸ“ ä½æ‰€ï¼š</span><br>
                        ${item.address}
                    </div>
                    
                    ${floorDisplay}
                    
                    <div class="info-row">
                        <span class="info-label">ğŸ‘¤ æ‹…å½“è€…ï¼š</span>
                        ${item.contact || 'æœªç™»éŒ²'}
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">ğŸ“ é›»è©±ï¼š</span>
                        <a href="tel:${item.phone}" style="color: #4285f4;">${item.phone || 'æœªç™»éŒ²'}</a>
                    </div>
                    
                    ${item.info ? `
                    <div class="info-row">
                        <span class="info-label">ğŸ“ ä¼šç¤¾æƒ…å ±ï¼š</span><br>
                        ${item.info}
                    </div>
                    ` : ''}
                    
                    <hr style="margin: 12px 0; border: none; border-top: 1px solid #eee;">
                    
                    <div class="info-row">
                        <span class="info-label">ğŸ¨ ãƒ«ãƒ¼ãƒˆï¼š</span>
                        <div class="route-select">
                            <select id="route_${item.id}" onchange="updateColorPreview('${item.id}')">
                                ${routeOptions}
                            </select>
                            <div class="color-preview" id="colorPreview_${item.id}" style="background: ${route.color};"></div>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">ğŸ“… ã‚¢ãƒæ—¥æ™‚ï¼š</span>
                        <input type="date" id="date_${item.id}" value="${item.appointmentDate}">
                        <input type="time" id="time_${item.id}" value="${item.appointmentTime}" style="margin-top: 4px;">
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">âš ï¸ æ³¨æ„äº‹é …ï¼š</span>
                        <textarea id="note_${item.id}" placeholder="é§è»Šå ´æƒ…å ±ãªã©...">${item.note || ''}</textarea>
                    </div>
                    
                    <button class="save-btn" onclick="saveAppointment('${item.id}')">
                        ğŸ’¾ ä¿å­˜ã™ã‚‹
                    </button>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        }
        
        // è‰²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updateColorPreview(itemId) {
            const select = document.getElementById(`route_${itemId}`);
            const preview = document.getElementById(`colorPreview_${itemId}`);
            const routeId = parseInt(select.value);
            const route = ROUTES[routeId];
            preview.style.background = route.color;
        }
        
        // ã‚¢ãƒæƒ…å ±ã‚’ä¿å­˜
        function saveAppointment(itemId) {
            const item = locationData.find(d => d.id === itemId);
            if (!item) return;
            
            item.routeId = parseInt(document.getElementById(`route_${itemId}`).value);
            item.appointmentDate = document.getElementById(`date_${itemId}`).value;
            item.appointmentTime = document.getElementById(`time_${itemId}`).value;
            item.note = document.getElementById(`note_${itemId}`).value;
            
            // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
            const markerIndex = markers.findIndex(m => m.itemId === itemId);
            if (markerIndex >= 0) {
                markers[markerIndex].setMap(null);
                markers.splice(markerIndex, 1);
                createMarker(item);
            }
            
            // ä¿å­˜
            saveToStorage();
            updateLegend();
            
            infoWindow.close();
            
            // ä¿å­˜å®Œäº†é€šçŸ¥
            alert('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
        }
        
        // å‡¡ä¾‹ã‚’æ›´æ–°
        function updateLegend() {
            const legend = document.getElementById('legend');
            const legendItems = document.getElementById('legendItems');
            
            // ä½¿ç”¨ä¸­ã®ãƒ«ãƒ¼ãƒˆã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const routeCounts = {};
            locationData.forEach(item => {
                routeCounts[item.routeId] = (routeCounts[item.routeId] || 0) + 1;
            });
            
            if (Object.keys(routeCounts).length === 0) {
                legend.style.display = 'none';
                return;
            }
            
            legend.style.display = 'block';
            
            let html = '';
            ROUTES.forEach(route => {
                const count = routeCounts[route.id] || 0;
                if (count > 0) {
                    html += `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${route.color};"></div>
                            <span>${route.name}ï¼ˆ${count}ä»¶ï¼‰</span>
                        </div>
                    `;
                }
            });
            
            legendItems.innerHTML = html;
        }
        
        // LocalStorageã«ä¿å­˜
        function saveToStorage() {
            localStorage.setItem('maintenanceMapData', JSON.stringify(locationData));
        }
        
        // LocalStorageã‹ã‚‰å¾©å…ƒ
        function loadFromStorage() {
            const saved = localStorage.getItem('maintenanceMapData');
            if (saved) {
                try {
                    locationData = JSON.parse(saved);
                    
                    const bounds = new google.maps.LatLngBounds();
                    
                    locationData.forEach(item => {
                        if (item.position) {
                            createMarker(item);
                            bounds.extend(item.position);
                        }
                    });
                    
                    if (locationData.length > 0) {
                        map.fitBounds(bounds);
                        document.getElementById('countBadge').textContent = `${locationData.length}ä»¶`;
                    }
                    
                    updateLegend();
                } catch (e) {
                    console.error('ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
                }
            }
        }
        
        // PDFå‡ºåŠ›
        function exportPDF() {
            if (locationData.length === 0) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // æ¨ªå‘ãA4
            
            // æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œã®ãŸã‚ã€ã‚·ãƒ³ãƒ—ãƒ«ãªè‹±å­—ãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨
            doc.setFont('helvetica');
            
            // ã‚¿ã‚¤ãƒˆãƒ«
            doc.setFontSize(18);
            doc.text('Maintenance Map - Appointment List', 14, 15);
            
            // æ—¥ä»˜
            doc.setFontSize(10);
            const today = new Date().toLocaleDateString('ja-JP');
            doc.text(`Output: ${today}`, 14, 22);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆ
            const tableData = locationData.map(item => {
                const route = ROUTES[item.routeId] || ROUTES[0];
                const dateTime = item.appointmentDate ? 
                    `${item.appointmentDate} ${item.appointmentTime || ''}`.trim() : '';
                
                // å°æ•°è¡¨ç¤º
                const countStr = item.count > 1 ? `${item.count}å°` : '1å°';
                
                // éšæ•°æƒ…å ±
                const floorStr = (item.floors && item.floors.length > 0) ? item.floors.join(', ') : '';
                
                return [
                    item.no,
                    item.company,
                    countStr,
                    item.address,
                    floorStr,
                    item.phone,
                    item.contact,
                    route.name,
                    dateTime,
                    item.note || ''
                ];
            });
            
            // ãƒ«ãƒ¼ãƒˆã§ã‚½ãƒ¼ãƒˆ
            tableData.sort((a, b) => {
                const routeA = ROUTES.findIndex(r => r.name === a[7]);
                const routeB = ROUTES.findIndex(r => r.name === b[7]);
                return routeA - routeB;
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
            doc.autoTable({
                head: [[
                    'No', 'Company', 'Count', 'Address', 'Floor',
                    'Phone', 'Contact', 'Route', 'Appointment', 'Note'
                ]],
                body: tableData,
                startY: 28,
                styles: {
                    fontSize: 7,
                    cellPadding: 2,
                },
                headStyles: {
                    fillColor: [66, 133, 244],
                    textColor: 255,
                    fontStyle: 'bold',
                },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 12 },
                    3: { cellWidth: 45 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 22 },
                    6: { cellWidth: 18 },
                    7: { cellWidth: 16 },
                    8: { cellWidth: 25 },
                    9: { cellWidth: 30 },
                },
                didParseCell: function(data) {
                    // ãƒ«ãƒ¼ãƒˆåˆ—ã«è‰²ã‚’ã¤ã‘ã‚‹
                    if (data.column.index === 7 && data.section === 'body') {
                        const routeName = data.cell.raw;
                        const route = ROUTES.find(r => r.name === routeName);
                        if (route && route.id !== 0) {
                            // RGBå¤‰æ›
                            const hex = route.color.replace('#', '');
                            const r = parseInt(hex.substr(0, 2), 16);
                            const g = parseInt(hex.substr(2, 2), 16);
                            const b = parseInt(hex.substr(4, 2), 16);
                            data.cell.styles.fillColor = [r, g, b];
                            // æ˜ã‚‹ã„è‰²ã¯é»’æ–‡å­—ã€æš—ã„è‰²ã¯ç™½æ–‡å­—
                            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                            data.cell.styles.textColor = brightness > 128 ? [0, 0, 0] : [255, 255, 255];
                        }
                    }
                }
            });
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const fileName = `maintenance_map_${today.replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
        }
        
        // å¾…æ©Ÿé–¢æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>

    <!-- â˜…â˜…â˜… ä¸‹ã® YOUR_API_KEY_HERE ã‚’ã‚ãªãŸã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ã­ï¼ â˜…â˜…â˜… -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAbzPpvv1voF_qjTfyQdKiCZ0cGL6yeVio&callback=initMap">
    </script>
</body>
</html>
