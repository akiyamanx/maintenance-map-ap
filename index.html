<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒãƒƒãƒ—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: #4285f4;
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 100;
        }
        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        /* CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
        .upload-btn {
            background: white;
            color: #4285f4;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .upload-btn:hover {
            background: #f0f0f0;
        }
        
        /* ä»¶æ•°è¡¨ç¤º */
        .count-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            margin-left: auto;
        }
        
        /* åœ°å›³ */
        #map {
            width: 100%;
            height: calc(100vh - 56px);
        }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’éš ã™ */
        #csvInput {
            display: none;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        .loading.show {
            display: block;
        }
        
        /* ä¼šç¤¾åãƒ©ãƒ™ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .marker-label {
            background: white;
            border: 2px solid #4285f4;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒãƒƒãƒ—</h1>
        <button class="upload-btn" onclick="document.getElementById('csvInput').click()">
            ğŸ“ CSVèª­è¾¼
        </button>
        <div class="count-badge" id="countBadge">0ä»¶</div>
    </div>
    
    <input type="file" id="csvInput" accept=".csv" onchange="handleCSV(event)">
    
    <div id="map"></div>
    
    <div class="loading" id="loading">
        ğŸ“ ä½æ‰€ã‚’å¤‰æ›ä¸­...<br>
        <span id="loadingProgress"></span>
    </div>

    <script>
        let map;
        let markers = [];
        let infoWindow;
        
        function initMap() {
            // åƒä»£ç”°åŒºã‚’ä¸­å¿ƒã«è¨­å®š
            const chiyoda = { lat: 35.6939, lng: 139.7535 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: chiyoda,
            });
            
            // æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆå¹ãå‡ºã—ï¼‰ã‚’1ã¤ã ã‘ä½œæˆ
            infoWindow = new google.maps.InfoWindow();
        }
        
        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        function handleCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        // CSVã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 5) {
                    data.push({
                        no: values[0] || '',
                        company: values[1] || '',
                        address: values[2] || '',
                        phone: values[3] || '',
                        contact: values[4] || '',
                        info: values[5] || ''
                    });
                }
            }
            
            if (data.length > 0) {
                geocodeAddresses(data);
            } else {
                alert('CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            }
        }
        
        // CSVã®1è¡Œã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }
        
        // ä½æ‰€ã‚’ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆåº§æ¨™ã«å¤‰æ›ï¼‰
        async function geocodeAddresses(data) {
            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            markers.forEach(m => m.setMap(null));
            markers = [];
            
            const loading = document.getElementById('loading');
            const progress = document.getElementById('loadingProgress');
            loading.classList.add('show');
            
            const geocoder = new google.maps.Geocoder();
            const bounds = new google.maps.LatLngBounds();
            let successCount = 0;
            
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                progress.textContent = `${i + 1} / ${data.length}`;
                
                try {
                    const position = await geocodeAddress(geocoder, item.address);
                    if (position) {
                        createMarker(item, position);
                        bounds.extend(position);
                        successCount++;
                    }
                } catch (error) {
                    console.warn(`ä½æ‰€å¤‰æ›å¤±æ•—: ${item.address}`, error);
                }
                
                // APIåˆ¶é™å¯¾ç­–ï¼šå°‘ã—å¾…ã¤
                await sleep(200);
            }
            
            loading.classList.remove('show');
            
            // ä»¶æ•°ã‚’æ›´æ–°
            document.getElementById('countBadge').textContent = `${successCount}ä»¶`;
            
            // ã™ã¹ã¦ã®ãƒ”ãƒ³ãŒè¦‹ãˆã‚‹ç¯„å›²ã«èª¿æ•´
            if (successCount > 0) {
                map.fitBounds(bounds);
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('csvInput').value = '';
        }
        
        // ä½æ‰€â†’åº§æ¨™å¤‰æ›
        function geocodeAddress(geocoder, address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ address: address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve(results[0].geometry.location);
                    } else {
                        reject(status);
                    }
                });
            });
        }
        
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
        function createMarker(item, position) {
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: item.company,
                label: {
                    text: item.company,
                    className: 'marker-label',
                    fontSize: '11px',
                    fontWeight: 'bold'
                },
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    labelOrigin: new google.maps.Point(15, -10)
                }
            });
            
            // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º
            marker.addListener('click', () => {
                const content = `
                    <div style="padding: 8px; min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; color: #333; font-size: 16px;">
                            ${item.company}
                        </h3>
                        <p style="margin: 4px 0; font-size: 13px;">
                            <strong>ğŸ“ ä½æ‰€ï¼š</strong><br>${item.address}
                        </p>
                        <p style="margin: 4px 0; font-size: 13px;">
                            <strong>ğŸ‘¤ æ‹…å½“è€…ï¼š</strong>${item.contact || 'æœªç™»éŒ²'}
                        </p>
                        <p style="margin: 4px 0; font-size: 13px;">
                            <strong>ğŸ“ é›»è©±ï¼š</strong>
                            <a href="tel:${item.phone}" style="color: #4285f4;">${item.phone || 'æœªç™»éŒ²'}</a>
                        </p>
                        ${item.info ? `
                        <p style="margin: 8px 0 4px 0; padding-top: 8px; border-top: 1px solid #eee; font-size: 13px;">
                            <strong>ğŸ“ ä¼šç¤¾æƒ…å ±ï¼š</strong><br>${item.info}
                        </p>
                        ` : ''}
                    </div>
                `;
                
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });
            
            markers.push(marker);
        }
        
        // å¾…æ©Ÿé–¢æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>

    <!-- â˜…â˜…â˜… ä¸‹ã® YOUR_API_KEY_HERE ã‚’ã‚ãªãŸã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ã­ï¼ â˜…â˜…â˜… -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY_HERE&callback=initMap">
    </script>
</body>
</html>
