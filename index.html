<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>メンテナンスマップ v2.2</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a56db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="expense-styles.css">
    <link rel="stylesheet" href="route-order-styles.css">
</head>
<body>
    <!-- v2.0 スプラッシュ画面 -->
    <div id="splashScreen" class="splash-overlay">
        <div class="splash-content">
            <div class="splash-icon">📍</div>
            <h1 class="splash-title">メンテナンスマップ</h1>
            <p class="splash-sub">Maintenance Route Manager</p>
            <p class="splash-ver">v2.2</p>
            <div class="splash-features">
                <span>📊 CSV取込</span>
                <span>🗺️ 自動マッピング</span>
                <span>🛣️ ルート管理</span>
                <span>📄 PDF出力</span>
                <span>💰 交通費精算</span>
                <span>📏 距離計算</span>
            </div>
            <button class="splash-btn" onclick="closeSplash()">はじめる</button>
            <p class="splash-credit">COCOMI CORE 🤍</p>
        </div>
    </div>

    <!-- ヘッダー -->
    <header class="app-header">
        <h1 class="app-title">📍 メンテナンスマップ</h1>
        <div class="header-actions">
            <label class="btn btn-upload" for="fileInput">📁 読込</label>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none">
            <button class="btn btn-add" onclick="showAddModal()">➕ 追加</button>
            <button class="btn btn-pdf" onclick="exportPDF()">📄 PDF</button>
            <button class="btn btn-menu" onclick="toggleMenu()">⚙️</button>
        </div>
        <div class="count-badge" id="countBadge">0件</div>
    </header>

    <!-- メニューパネル -->
    <div class="menu-panel" id="menuPanel" style="display:none;">
        <button onclick="exportBackup()">💾 バックアップ保存</button>
        <button onclick="importBackup()">📂 バックアップ復元</button>
        <input type="file" id="backupInput" accept=".json" style="display:none">
        <button onclick="showSettingsModal()">⚙️ 設定</button>
        <button onclick="showResetConfirm()">🗑️ 全データ削除</button>
        <button onclick="window.open('help.html','_blank')">❓ ヘルプ</button>
    </div>

    <!-- 地図 -->
    <div id="map"></div>

    <!-- ルート凡例 -->
    <div class="legend" id="legend" style="display:none;">
        <div class="legend-title">📍 ルート凡例 <button class="legend-close" onclick="toggleLegend()">✕</button></div>
        <div id="legendItems"></div>
    </div>

    <!-- 下部パネル -->
    <div class="bottom-panel" id="bottomPanel">
        <div class="panel-handle" onclick="togglePanel()">
            <div class="handle-bar"></div>
        </div>
        <div class="panel-tabs">
            <button class="tab active" data-tab="list" onclick="switchTab('list')">📋 リスト</button>
            <button class="tab" data-tab="route" onclick="switchTab('route')">🗺️ ルート</button>
            <button class="tab" data-tab="summary" onclick="switchTab('summary')">📊 集計</button>
            <button class="tab" data-tab="expense" onclick="switchTab('expense')">💰 精算書</button>
        </div>
        <div class="panel-content">
            <div class="tab-content active" id="tabList">
                <div id="customerList" class="customer-list"></div>
            </div>
            <div class="tab-content" id="tabRoute">
                <div id="routeManager" class="route-manager"></div>
            </div>
            <div class="tab-content" id="tabSummary">
                <div id="summaryContent" class="summary-content">
                    <p class="empty-msg">ルートを作成すると集計が表示されます</p>
                </div>
            </div>
            <div class="tab-content" id="tabExpense">
                <p class="empty-msg">💰 精算書タブを選択すると表示されます</p>
            </div>
        </div>
    </div>

    <!-- 手動追加モーダル -->
    <div class="modal-overlay" id="addModal" style="display:none;">
        <div class="modal">
            <h2>➕ メンテナンス先を追加</h2>
            <div class="modal-row">
                <label>会社名 *</label>
                <input type="text" id="addCompany" placeholder="例：㈱サンプル会社">
            </div>
            <div class="modal-row">
                <label>住所 *</label>
                <input type="text" id="addAddress" placeholder="例：東京都港区虎ノ門1-1-1">
            </div>
            <div class="modal-row">
                <label>電話番号</label>
                <input type="tel" id="addPhone" placeholder="例：03-1234-5678">
            </div>
            <div class="modal-row">
                <label>担当者</label>
                <input type="text" id="addContact" placeholder="例：山田様">
            </div>
            <div class="modal-row">
                <label>備考</label>
                <textarea id="addNote" placeholder="台数や機種、駐車場情報など..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="hideAddModal()">キャンセル</button>
                <button class="modal-submit" onclick="addNewLocation()">追加する</button>
            </div>
        </div>
    </div>

    <!-- 詳細編集モーダル -->
    <div class="modal-overlay" id="editModal" style="display:none;">
        <div class="modal">
            <h2>📝 詳細編集</h2>
            <div class="modal-row">
                <label>会社名</label>
                <input type="text" id="editCompany">
            </div>
            <div class="modal-row">
                <label>住所</label>
                <input type="text" id="editAddress">
            </div>
            <div class="modal-row">
                <label>電話番号</label>
                <input type="tel" id="editPhone">
            </div>
            <div class="modal-row">
                <label>担当者</label>
                <input type="text" id="editContact">
            </div>
            <div class="modal-row">
                <label>ルート</label>
                <select id="editRoute"></select>
            </div>
            <div class="modal-row">
                <label>アポ日時</label>
                <input type="datetime-local" id="editAppoDate">
            </div>
            <div class="modal-row">
                <label>ステータス</label>
                <select id="editStatus">
                    <option value="pending">未アポ</option>
                    <option value="appointed">アポ済み</option>
                    <option value="completed">完了</option>
                </select>
            </div>
            <div class="modal-row">
                <label>備考</label>
                <textarea id="editNote"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="hideEditModal()">キャンセル</button>
                <button class="modal-delete" onclick="deleteLocation()">🗑️ 削除</button>
                <button class="modal-submit" onclick="saveEdit()">保存</button>
            </div>
        </div>
    </div>

    <!-- 設定モーダル -->
    <div class="modal-overlay" id="settingsModal" style="display:none;">
        <div class="modal">
            <h2>⚙️ 設定</h2>
            <div class="modal-row">
                <label>自宅住所（出発点）</label>
                <input type="text" id="settingHomeAddress" placeholder="例：千葉県袖ケ浦市...">
            </div>
            <div class="modal-row">
                <label>Google Maps APIキー</label>
                <input type="text" id="settingApiKey" placeholder="APIキーを入力">
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="hideSettingsModal()">キャンセル</button>
                <button class="modal-submit" onclick="saveSettings()">保存</button>
            </div>
        </div>
    </div>

    <!-- リセット確認モーダル -->
    <div class="modal-overlay" id="resetModal" style="display:none;">
        <div class="modal">
            <h2>🗑️ データをリセット</h2>
            <p class="confirm-text">
                現在のデータをすべて削除しますか？<br>
                この操作は取り消せません。<br>
                <strong id="resetCount">0件</strong>のデータが削除されます
            </p>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="hideResetConfirm()">キャンセル</button>
                <button class="modal-delete" onclick="resetAllData()">削除する</button>
            </div>
        </div>
    </div>

    <!-- ローディング -->
    <div class="loading-overlay" id="loading" style="display:none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>📍 処理中...</p>
            <p id="loadingProgress"></p>
        </div>
    </div>

    <!-- ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- v2.0 アプリモジュール -->
    <script src="data-storage.js"></script>
    <script src="csv-handler.js"></script>
    <script src="map-core.js"></script>
    <script src="route-manager.js"></script>
    <script src="expense-form.js"></script>
    <script src="expense-pdf.js"></script>
    <script src="route-order.js"></script>
    <script src="segment-dialog.js"></script>
    <script src="distance-calc.js"></script>
    <script src="etc-reader.js"></script>
    <script src="ui-actions.js"></script>

    <!-- v2.0 APIキー読み込み＋初期化 -->
    <script>
        // v2.0 - アプリ初期化
        // APIキーは設定から読み込む（設定未完了なら入力を促す）
        const settings = DataStorage.getSettings();
        if (settings.apiKey) {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${settings.apiKey}&libraries=places,geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        } else {
            // v2.0 - APIキー未設定時
            window.addEventListener('DOMContentLoaded', () => {
                closeSplash();
                showSettingsModal();
                alert('Google Maps APIキーを設定してください。\n設定画面が開きます。');
            });
        }

        // v2.0 - スプラッシュ画面制御
        function closeSplash() {
            const splash = document.getElementById('splashScreen');
            splash.style.opacity = '0';
            setTimeout(() => splash.style.display = 'none', 500);
        }

        // v2.0 - ファイル読込イベント
        document.getElementById('fileInput').addEventListener('change', (e) => {
            CsvHandler.handleFile(e);
        });

        // v2.0 - バックアップ復元イベント
        document.getElementById('backupInput').addEventListener('change', (e) => {
            DataStorage.importBackup(e);
        });
    </script>
</body>
</html>
