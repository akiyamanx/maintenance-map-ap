# COCOMI CI ãƒ†ã‚¹ãƒˆå¯©æŸ» v1.0
# COCOMIãƒ•ã‚¡ãƒŸãƒªãƒ¼å…±é€šCI + LINEé€šçŸ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

name: COCOMI CI ãƒ†ã‚¹ãƒˆå¯©æŸ»

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      # â‘  ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # â‘¡ å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•æ¤œå‡º
      - name: å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
        id: detect
        run: |
          has_sh=false
          has_js=false
          has_css=false
          has_html=false

          if find . -name '*.sh' -not -path './.git/*' | grep -q .; then
            has_sh=true
          fi
          if find . -name '*.js' -not -path './.git/*' -not -path './node_modules/*' | grep -q .; then
            has_js=true
          fi
          if find . -name '*.css' -not -path './.git/*' -not -path './node_modules/*' | grep -q .; then
            has_css=true
          fi
          if find . -name '*.html' -not -path './.git/*' -not -path './node_modules/*' | grep -q .; then
            has_html=true
          fi

          echo "has_sh=$has_sh" >> "$GITHUB_OUTPUT"
          echo "has_js=$has_js" >> "$GITHUB_OUTPUT"
          echo "has_css=$has_css" >> "$GITHUB_OUTPUT"
          echo "has_html=$has_html" >> "$GITHUB_OUTPUT"

          echo "### æ¤œå‡ºçµæœ" >> "$GITHUB_STEP_SUMMARY"
          echo "| æ‹¡å¼µå­ | æ¤œå‡º |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| .sh | $has_sh |" >> "$GITHUB_STEP_SUMMARY"
          echo "| .js | $has_js |" >> "$GITHUB_STEP_SUMMARY"
          echo "| .css | $has_css |" >> "$GITHUB_STEP_SUMMARY"
          echo "| .html | $has_html |" >> "$GITHUB_STEP_SUMMARY"

      # â‘¢ ShellCheckï¼ˆ.shãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
      - name: ShellCheck
        id: shellcheck
        if: steps.detect.outputs.has_sh == 'true'
        run: |
          sudo apt-get install -y shellcheck > /dev/null 2>&1
          fail_detail=""
          failed=false

          while IFS= read -r f; do
            if ! output=$(shellcheck -e SC1091,SC2034 "$f" 2>&1); then
              failed=true
              fail_detail="${fail_detail}${f}:\n${output}\n\n"
            fi
          done < <(find . -name '*.sh' -not -path './.git/*')

          if [ "$failed" = true ]; then
            echo "fail_detail<<EOF" >> "$GITHUB_OUTPUT"
            echo -e "$fail_detail" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "::error::ShellCheck ã§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            exit 1
          fi
          echo "fail_detail=" >> "$GITHUB_OUTPUT"

      # â‘£ 500è¡Œãƒã‚§ãƒƒã‚¯ï¼ˆå…¨æ‹¡å¼µå­ã€sw.jså«ã‚€ï¼‰
      - name: 500è¡Œãƒã‚§ãƒƒã‚¯
        id: linecheck
        run: |
          fail_detail=""
          failed=false

          while IFS= read -r f; do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 500 ]; then
              failed=true
              fail_detail="${fail_detail}${f}: ${lines}è¡Œï¼ˆä¸Šé™500è¡Œè¶…éï¼‰\n"
            fi
          done < <(find . \( -name '*.sh' -o -name '*.js' -o -name '*.css' -o -name '*.html' \) -not -path './.git/*' -not -path './node_modules/*')

          if [ "$failed" = true ]; then
            echo "fail_detail<<EOF" >> "$GITHUB_OUTPUT"
            echo -e "$fail_detail" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "::error::500è¡Œè¶…éãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™"
            exit 1
          fi
          echo "fail_detail=" >> "$GITHUB_OUTPUT"

      # â‘¤ å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆ.sh/.js/.cssã€sw.jsé™¤å¤–ï¼‰
      - name: å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
        id: headercheck
        run: |
          fail_detail=""
          failed=false

          while IFS= read -r f; do
            basename=$(basename "$f")
            # sw.jsé™¤å¤–
            if [ "$basename" = "sw.js" ]; then
              continue
            fi

            first_line=$(head -n 1 "$f")
            has_comment=false

            case "$basename" in
              *.sh)
                # ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: #! or # ã§å§‹ã¾ã‚‹
                if echo "$first_line" | grep -qE '^#'; then
                  has_comment=true
                fi
                ;;
              *.js)
                # JavaScript: // or /* ã§å§‹ã¾ã‚‹
                if echo "$first_line" | grep -qE '^(//|/\*)'; then
                  has_comment=true
                fi
                ;;
              *.css)
                # CSS: /* ã§å§‹ã¾ã‚‹
                if echo "$first_line" | grep -qE '^/\*'; then
                  has_comment=true
                fi
                ;;
            esac

            if [ "$has_comment" = false ]; then
              failed=true
              fail_detail="${fail_detail}${f}: å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆãªã—\n"
            fi
          done < <(find . \( -name '*.sh' -o -name '*.js' -o -name '*.css' \) -not -path './.git/*' -not -path './node_modules/*')

          if [ "$failed" = true ]; then
            echo "fail_detail<<EOF" >> "$GITHUB_OUTPUT"
            echo -e "$fail_detail" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "::error::å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™"
            exit 1
          fi
          echo "fail_detail=" >> "$GITHUB_OUTPUT"

      # â‘¥ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãƒã‚§ãƒƒã‚¯ï¼ˆ.sh/.js/.cssã€sw.jsé™¤å¤–ï¼‰
      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãƒã‚§ãƒƒã‚¯
        id: versioncheck
        run: |
          fail_detail=""
          failed=false

          while IFS= read -r f; do
            basename=$(basename "$f")
            # sw.jsé™¤å¤–
            if [ "$basename" = "sw.js" ]; then
              continue
            fi

            # å…ˆé ­10è¡Œä»¥å†…ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹ã‹ç¢ºèª
            # ä¾‹: v1.0, v2.1, Version 1.0, version: 2.0 ç­‰
            if ! head -n 10 "$f" | grep -qiE '(v[0-9]+\.[0-9]+|version\s*[:=]?\s*[0-9]+\.[0-9]+)'; then
              failed=true
              fail_detail="${fail_detail}${f}: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãªã—ï¼ˆå…ˆé ­10è¡Œä»¥å†…ï¼‰\n"
            fi
          done < <(find . \( -name '*.sh' -o -name '*.js' -o -name '*.css' \) -not -path './.git/*' -not -path './node_modules/*')

          if [ "$failed" = true ]; then
            echo "fail_detail<<EOF" >> "$GITHUB_OUTPUT"
            echo -e "$fail_detail" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "::error::ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™"
            exit 1
          fi
          echo "fail_detail=" >> "$GITHUB_OUTPUT"

      # â‘¦ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        id: securitycheck
        run: |
          fail_detail=""
          failed=false

          # config.json / .env ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¼æ´©ãƒã‚§ãƒƒã‚¯
          if find . -name 'config.json' -not -path './.git/*' | grep -q .; then
            failed=true
            fail_detail="${fail_detail}config.json ãŒãƒªãƒã‚¸ãƒˆãƒªã«å«ã¾ã‚Œã¦ã„ã¾ã™\n"
          fi
          if find . -name '.env' -not -path './.git/*' | grep -q .; then
            failed=true
            fail_detail="${fail_detail}.env ãŒãƒªãƒã‚¸ãƒˆãƒªã«å«ã¾ã‚Œã¦ã„ã¾ã™\n"
          fi

          # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
          while IFS= read -r f; do
            # GitHub Personal Access Token
            if grep -qE 'ghp_[A-Za-z0-9]{36,}' "$f"; then
              failed=true
              fail_detail="${fail_detail}${f}: GitHub PAT (ghp_) ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™\n"
            fi
            # Anthropic API Key
            if grep -qE 'sk-ant-[A-Za-z0-9_-]+' "$f"; then
              failed=true
              fail_detail="${fail_detail}${f}: Anthropic API Key (sk-ant-) ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™\n"
            fi
            # Slack Bot Token
            if grep -qE 'xoxb-[A-Za-z0-9-]+' "$f"; then
              failed=true
              fail_detail="${fail_detail}${f}: Slack Token (xoxb-) ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™\n"
            fi
          done < <(find . \( -name '*.sh' -o -name '*.js' -o -name '*.css' -o -name '*.html' -o -name '*.json' -o -name '*.yml' -o -name '*.yaml' \) -not -path './.git/*' -not -path './node_modules/*')

          if [ "$failed" = true ]; then
            echo "fail_detail<<EOF" >> "$GITHUB_OUTPUT"
            echo -e "$fail_detail" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "::error::ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            exit 1
          fi
          echo "fail_detail=" >> "$GITHUB_OUTPUT"

      # â‘§ ã‚µãƒãƒªãƒ¼å‡ºåŠ›ï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
      - name: ã‚µãƒãƒªãƒ¼å‡ºåŠ›
        if: always()
        run: |
          echo "## COCOMI CI ãƒ†ã‚¹ãƒˆå¯©æŸ» çµæœ" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------------|------|" >> "$GITHUB_STEP_SUMMARY"

          # å„ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’åˆ¤å®š
          checks=("shellcheck:ShellCheck" "linecheck:500è¡Œãƒã‚§ãƒƒã‚¯" "headercheck:å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆ" "versioncheck:ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·" "securitycheck:ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£")
          for item in "${checks[@]}"; do
            id="${item%%:*}"
            label="${item##*:}"
            case "$id" in
              shellcheck)
                if [ "${{ steps.detect.outputs.has_sh }}" != "true" ]; then
                  echo "| $label | â­ ã‚¹ã‚­ãƒƒãƒ— |" >> "$GITHUB_STEP_SUMMARY"
                elif [ "${{ steps.shellcheck.outcome }}" = "success" ]; then
                  echo "| $label | âœ… åˆæ ¼ |" >> "$GITHUB_STEP_SUMMARY"
                else
                  echo "| $label | âŒ ä¸åˆæ ¼ |" >> "$GITHUB_STEP_SUMMARY"
                fi
                ;;
              linecheck)
                if [ "${{ steps.linecheck.outcome }}" = "success" ]; then
                  echo "| $label | âœ… åˆæ ¼ |" >> "$GITHUB_STEP_SUMMARY"
                else
                  echo "| $label | âŒ ä¸åˆæ ¼ |" >> "$GITHUB_STEP_SUMMARY"
                fi
                ;;
              headercheck)
                if [ "${{ steps.headercheck.outcome }}" = "success" ]; then
                  echo "| $label | âœ… åˆæ ¼ |" >> "$GITHUB_STEP_SUMMARY"
                else
                  echo "| $label | âŒ ä¸åˆæ ¼ |" >> "$GITHUB_STEP_SUMMARY"
                fi
                ;;
              versioncheck)
                if [ "${{ steps.versioncheck.outcome }}" = "success" ]; then
                  echo "| $label | âœ… åˆæ ¼ |" >> "$GITHUB_STEP_SUMMARY"
                else
                  echo "| $label | âŒ ä¸åˆæ ¼ |" >> "$GITHUB_STEP_SUMMARY"
                fi
                ;;
              securitycheck)
                if [ "${{ steps.securitycheck.outcome }}" = "success" ]; then
                  echo "| $label | âœ… åˆæ ¼ |" >> "$GITHUB_STEP_SUMMARY"
                else
                  echo "| $label | âŒ ä¸åˆæ ¼ |" >> "$GITHUB_STEP_SUMMARY"
                fi
                ;;
            esac
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "ğŸ“‹ ã‚³ãƒŸãƒƒãƒˆ: \`${{ github.sha }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "ğŸ‘¤ å®Ÿè¡Œè€…: ${{ github.actor }}" >> "$GITHUB_STEP_SUMMARY"

      # â‘¨ LINEé€šçŸ¥ï¼ˆæˆåŠŸæ™‚ï¼‰
      - name: LINEé€šçŸ¥ï¼ˆæˆåŠŸï¼‰
        if: success()
        env:
          LINE_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        run: |
          REPO_NAME="${{ github.repository }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')

          MESSAGE="âœ… CIåˆæ ¼ï¼

          ğŸ“¦ ${REPO_NAME}
          ğŸ“ ${SHORT_SHA}: ${COMMIT_MSG}

          ãƒã‚§ãƒƒã‚¯çµæœ:
          âœ… 500è¡Œãƒã‚§ãƒƒã‚¯: åˆæ ¼
          âœ… å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆ: åˆæ ¼
          âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·: åˆæ ¼
          âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: åˆæ ¼"

          # ShellCheckã®çµæœã‚’è¿½åŠ 
          if [ "${{ steps.detect.outputs.has_sh }}" = "true" ]; then
            MESSAGE="${MESSAGE}
          âœ… ShellCheck: åˆæ ¼"
          fi

          curl -s -X POST "https://api.line.me/v2/bot/message/push" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${LINE_TOKEN}" \
            -d "$(jq -n \
              --arg to "$LINE_USER_ID" \
              --arg text "$MESSAGE" \
              '{to: $to, messages: [{type: "text", text: $text}]}'
            )"

      # â‘© LINEé€šçŸ¥ï¼ˆå¤±æ•—æ™‚ï¼‰
      - name: LINEé€šçŸ¥ï¼ˆå¤±æ•—ï¼‰
        if: failure()
        env:
          LINE_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        run: |
          REPO_NAME="${{ github.repository }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # å¤±æ•—ç†ç”±ã‚’åé›†
          FAIL_REASONS=""

          SHELLCHECK_DETAIL="${{ steps.shellcheck.outputs.fail_detail }}"
          LINECHECK_DETAIL="${{ steps.linecheck.outputs.fail_detail }}"
          HEADERCHECK_DETAIL="${{ steps.headercheck.outputs.fail_detail }}"
          VERSIONCHECK_DETAIL="${{ steps.versioncheck.outputs.fail_detail }}"
          SECURITYCHECK_DETAIL="${{ steps.securitycheck.outputs.fail_detail }}"

          if [ -n "$SHELLCHECK_DETAIL" ]; then
            FAIL_REASONS="${FAIL_REASONS}
          âŒ ShellCheck:
          ${SHELLCHECK_DETAIL}"
          fi

          if [ -n "$LINECHECK_DETAIL" ]; then
            FAIL_REASONS="${FAIL_REASONS}
          âŒ 500è¡Œãƒã‚§ãƒƒã‚¯:
          ${LINECHECK_DETAIL}"
          fi

          if [ -n "$HEADERCHECK_DETAIL" ]; then
            FAIL_REASONS="${FAIL_REASONS}
          âŒ å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆ:
          ${HEADERCHECK_DETAIL}"
          fi

          if [ -n "$VERSIONCHECK_DETAIL" ]; then
            FAIL_REASONS="${FAIL_REASONS}
          âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·:
          ${VERSIONCHECK_DETAIL}"
          fi

          if [ -n "$SECURITYCHECK_DETAIL" ]; then
            FAIL_REASONS="${FAIL_REASONS}
          âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:
          ${SECURITYCHECK_DETAIL}"
          fi

          MESSAGE="ğŸš¨ CIä¸åˆæ ¼ï¼

          ğŸ“¦ ${REPO_NAME}
          ğŸ“ ${SHORT_SHA}: ${COMMIT_MSG}
          ${FAIL_REASONS}

          ğŸ”— è©³ç´°: ${ACTIONS_URL}"

          curl -s -X POST "https://api.line.me/v2/bot/message/push" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${LINE_TOKEN}" \
            -d "$(jq -n \
              --arg to "$LINE_USER_ID" \
              --arg text "$MESSAGE" \
              '{to: $to, messages: [{type: "text", text: $text}]}'
            )"
