# R-MAP-001: メンテナンスマップ アプリ構成調査レポート

**調査日:** 2026-02-18
**対象:** maintenance-map-ap リポジトリ
**目的:** 交通費精算書機能を統合するための事前調査

---

## 1. ファイル構成ツリー

```
maintenance-map-ap/
├── index.html          # メインHTML（265行）
├── styles.css          # 全スタイル定義（412行）
├── data-storage.js     # データ永続化・CRUD（303行）
├── csv-handler.js      # CSV/Excel読込（221行）
├── map-core.js         # Google Maps管理（441行）
├── route-manager.js    # ルート管理・PDF出力（293行）
├── ui-actions.js       # UI制御・モーダル（169行）
├── sw.js               # Service Worker（63行）
├── manifest.json       # PWAマニフェスト
├── CLAUDE.md           # 開発ガイドライン
└── reports/
    └── maintenance-map/
        └── R-MAP-001.md  # 本レポート
```

**備考:**
- `help.html` はindex.htmlから参照されているが、ファイルが存在しない（未作成）
- `icon-192.png`, `icon-512.png` はmanifest.jsonから参照されているが、ファイルが存在しない（未作成）
- `.gitignore` は存在しない

---

## 2. 主要ファイルの役割一覧

| ファイル | 役割 | 行数 | モジュール名 |
|---|---|---|---|
| `index.html` | メインHTML。UIレイアウト（ヘッダー、地図、下部パネル）、5つのモーダル（追加・編集・設定・リセット・ローディング）、スプラッシュ画面、API初期化スクリプト | 265 | - |
| `styles.css` | 全スタイル定義。CSS変数ベースのデザインシステム。スプラッシュ、ヘッダー、地図、パネル、モーダル、ローディング、吹き出し等 | 412 | - |
| `data-storage.js` | LocalStorageによるデータ永続化。顧客CRUD、ルート定義（10ルート）、区間データ、ジオコーディングキャッシュ、設定管理、バックアップ/復元、v1.0→v2.0データ変換 | 303 | `DataStorage` (IIFE) |
| `csv-handler.js` | CSV/Excelファイル読込。CSVパース（ダブルクォート対応）、Excel読込（SheetJS使用）、ヘッダー自動検出、同一住所まとめ処理 | 221 | `CsvHandler` (IIFE) |
| `map-core.js` | Google Maps初期化、マーカー管理（作成・削除・更新・フォーカス）、ジオコーディング（バッチ処理・キャッシュ対応）、吹き出し表示、顧客リスト/件数バッジ更新 | 441 | `MapCore` (IIFE) |
| `route-manager.js` | ルートパネル表示、凡例表示、ルート線描画（Polyline）、PDF出力（jsPDF + AutoTable）、集計パネル更新 | 293 | `RouteManager` (IIFE) |
| `ui-actions.js` | グローバルUI関数。メニュートグル、各モーダルの表示/非表示、新規追加・編集保存・削除の実行、設定保存、バックアップ操作、パネル制御、タブ切替 | 169 | グローバル関数群 |
| `sw.js` | Service Worker。キャッシュ管理、ネットワーク優先フェッチ戦略、外部リソース除外 | 63 | - |
| `manifest.json` | PWAマニフェスト。アプリ名、アイコン定義、表示モード設定 | 22 | - |

---

## 3. 交通費精算書に関連するファイル

**現時点で交通費精算書に関連するファイルは存在しない。**

ただし、以下の既存機能・データ構造が交通費精算書と関連する可能性がある：

| 要素 | ファイル | 関連性 |
|---|---|---|
| ルート管理（10ルート） | `data-storage.js`, `route-manager.js` | ルート＝出張経路として交通費のグループ化に利用可能 |
| 顧客データ（住所・座標） | `data-storage.js` | 訪問先住所は交通費計算の起点/終点情報になる |
| 設定の「自宅住所（出発点）」 | `data-storage.js` L177, `ui-actions.js` | 交通費の出発地として利用可能 |
| PDF出力機能 | `route-manager.js` | jsPDF + AutoTableの基盤があり、精算書PDF出力に転用可能 |
| 区間データ（segments） | `data-storage.js` L106-120 | 高速/下道の区間データ保存構造が既にある（現在未使用の可能性あり） |
| Google Maps Geometry | `index.html` L234 | 距離計算に利用可能 |

---

## 4. 現在のアプリの主要機能

### データ入力
- CSV/Excelファイル読込（ヘッダー自動検出）
- 同一住所の自動まとめ（台数カウント）
- 手動での顧客追加
- 顧客情報編集（会社名、住所、電話番号、担当者、備考、ステータス、ルート、アポ日時）
- 顧客削除

### 地図機能
- Google Mapsによる全顧客のマッピング
- 住所→座標のジオコーディング（バッチ処理、200ms間隔）
- ジオコーディング結果のキャッシュ（LocalStorage）
- マーカーのカラー表示（ルート色 or ステータス色）
- マーカークリックで吹き出し表示（詳細情報、編集・電話ボタン付き）
- リストからマーカーへのフォーカス＆ズーム

### ルート管理
- 10ルートの定義（色分け）
- ルートへの顧客割当
- ルートパネルでの一覧表示
- ルート線の地図描画（Polyline）
- ルート凡例表示

### ステータス管理
- 3段階ステータス（未アポ→アポ済み→完了）
- アポ日時の記録
- ステータス別の色分け表示

### 集計・出力
- 全体集計（総件数、ステータス別件数）
- ルート別集計
- PDF出力（ルート別テーブル形式）

### データ管理
- JSONバックアップ保存/復元
- v1.0バックアップからの変換復元
- 全データリセット
- Google Maps APIキー設定
- 自宅住所（出発点）設定

### PWA対応
- Service Workerによるオフラインキャッシュ
- ネットワーク優先フェッチ戦略
- インストール可能なWebアプリ（manifest.json）

### UI/UX
- スプラッシュ画面
- スライドアップ式の下部パネル（リスト/ルート/集計タブ）
- レスポンシブデザイン（モバイル最適化）
- 電話番号タップで直接発信

---

## 5. 使用ライブラリ・API

### 外部API
| API | 用途 | 読込元 |
|---|---|---|
| Google Maps JavaScript API | 地図表示、マーカー管理 | ユーザー設定のAPIキーで動的読込 |
| Google Maps Geocoding API | 住所→座標変換 | Maps APIに含まれる |
| Google Maps Places API | プレイス情報（利用箇所は限定的） | Maps APIライブラリとして読込 |
| Google Maps Geometry API | 距離計算等（利用箇所は限定的） | Maps APIライブラリとして読込 |

### 外部ライブラリ（CDN）
| ライブラリ | バージョン | 用途 |
|---|---|---|
| SheetJS (xlsx) | 0.18.5 | Excelファイル（.xlsx, .xls）の読込・パース |
| jsPDF | 2.5.1 | PDF生成 |
| jsPDF-AutoTable | 3.5.31 | jsPDF用テーブル描画プラグイン |

### Webフォント
| フォント | 用途 |
|---|---|
| Noto Sans JP (Google Fonts) | アプリ全体の日本語フォント（400/500/700/900ウェイト） |

### Web標準API
| API | 用途 |
|---|---|
| LocalStorage | 全データの永続化 |
| Service Worker | PWAオフラインキャッシュ |
| File API (FileReader) | CSV/Excel/JSONファイルの読込 |
| Blob / URL.createObjectURL | バックアップファイルのダウンロード |

---

## 6. アーキテクチャ概要

```
┌─────────────────────────────────────────────┐
│                 index.html                   │
│  (UIレイアウト + モーダル + 初期化スクリプト)  │
├─────────────┬───────────────┬────────────────┤
│ ui-actions  │   map-core    │ route-manager  │
│ (UI制御)    │ (地図・マーカー)│ (ルート・PDF)  │
├─────────────┴───────┬───────┴────────────────┤
│     csv-handler     │     data-storage       │
│  (ファイル読込)      │  (LocalStorage管理)    │
├─────────────────────┴────────────────────────┤
│              外部ライブラリ                    │
│  Google Maps API / SheetJS / jsPDF           │
└──────────────────────────────────────────────┘
```

- **IIFE パターン**: 各JSモジュールはIIFE（即時実行関数式）でカプセル化
- **フレームワーク不使用**: Vanilla JSのみ
- **データフロー**: `DataStorage` → 各モジュールがLocalStorageを介してデータ共有
- **500行制限**: CLAUDE.mdにより各ファイル500行以内のルールあり

---

## 7. 交通費精算書統合に向けた所見

### 活用可能な既存資産
1. **PDF出力基盤** (`route-manager.js`): jsPDF + AutoTableが既に導入済み。精算書PDF出力に転用可能
2. **ルート・顧客データ**: 訪問先・出発地の情報が既にLocalStorageに保存されている
3. **区間データ構造** (`data-storage.js`): `mm_segments`キーで高速/下道の区間保存が既に設計されている
4. **Google Maps Geometry API**: 距離計算ライブラリが読込済み
5. **UIパターン**: モーダル・パネル・タブのUI部品が揃っている

### 統合時の検討事項
- 500行制限を考慮し、交通費精算書は独立した新規JSファイルとして作成が望ましい
- Service Worker (`sw.js`) のキャッシュリストに新ファイルを追加する必要あり
- LocalStorageの容量制限（約5MB）に注意。交通費データが増える場合は圧縮等の対策が必要
- `data-storage.js` に新しいストレージキー（例: `mm_expenses`）を追加する形が自然
